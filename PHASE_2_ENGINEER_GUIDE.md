# 第二阶段开发指南 - Prompt-to-Schema 对话系统

> 👋 欢迎来到 Metra 项目第二阶段！本文档将指导你完成核心功能的开发。

## 📋 任务概览

**阶段目标**：实现一个允许用户通过自然语言对话，定义出AI模型所需数据结构（Schema）的系统。  
**核心流程**：用户输入任务描述 -> AI 追问澄清问题 -> 用户回答 -> AI 生成并展示数据结构。  
**技术栈**：FastAPI, OpenAI API, React, Zustand

---

## 🎯 第二阶段任务清单

### 后端任务
- [ ] **创建对话模型**: 在数据库中创建 `Conversation` 和 `Message` 表，用于存储对话历史。
- [ ] **创建任务定义模型**: 创建 `TaskDefinition` 表，用于存储最终生成的数据结构（JSON Schema）。
- [ ] **实现对话 API**:
    - `POST /api/v1/conversations`: 开始一个新的对话。
    - `GET /api/v1/conversations/{id}`: 获取特定对话的历史消息。
    - `POST /api/v1/conversations/{id}/messages`: 发送一条新消息并获取AI的回复。
- [ ] **集成 OpenAI API**:
    - 设计一个 System Prompt，指导 GPT-4 如何扮演一个"数据结构专家"，通过提问来明确用户需求。
    - 在发送消息的API中，调用 GPT-4，并传入对话历史和 System Prompt。
    - 解析 GPT-4 的回复，判断是继续提问还是生成最终的 JSON Schema。
- [ ] **实现 Schema 生成与存储**:
    - 当AI判断需求明确后，生成 JSON Schema。
    - `POST /api/v1/task-definitions`: 将生成的 Schema 存储到 `TaskDefinition` 表中，并与相应的对话关联。

### 前端任务
- [ ] **微调并连接现有对话界面**:
    - 重点工作在 `metra-ai-factory-main/src/components/TaskBuilder.tsx` 文件。
    - 现有界面已经搭建好，任务是将其连接到后端对话API。
    - 微调UI以更好地展示对话历史（用户消息和AI回复）。
- [ ] **实现对话状态管理**:
    - 使用 `Zustand` 创建一个新的 `conversationStore` 来管理当前对话的状态，包括对话ID、消息列表、加载状态等。
- [ ] **连接对话 API**:
    - 在 `TaskBuilder.tsx` 中调用后端API，实现发送和接收消息的逻辑。
    - 处理加载状态，在等待AI回复时显示 loading 动画。
- [ ] **展示生成的 Schema**:
    - 当后端返回最终的 JSON Schema 时，在界面上清晰地展示出来。
    - 可以使用 `react-json-view` 或类似库来美化 JSON 的显示。
- [ ] **创建"下一步"流程**:
    - 当 Schema 生成后，提供一个"确认"或"保存"按钮，调用后端的 `POST /api/v1/task-definitions` 接口。
    - 成功后，可以引导用户进入第三阶段（数据构建）。

---

## ✨ 进一步提升：从可用到优秀

为了打造极致的用户体验和强大的系统，除了完成核心任务外，我们还应该规划以下增强功能：

### 提升用户体验 (UX)

- [ ] **流式响应 (Streaming Responses)**
    - **目标**: AI的回复应该像ChatGPT一样，一个字一个字地"流式"出现在界面上，而不是等全部生成完再一次性显示。
    - **实现**: 后端API需要使用FastAPI的 `StreamingResponse`。前端需要相应地处理这种流式数据，并实时渲染到界面上。
    - **价值**: 消除用户等待的焦虑感，让AI的响应看起来更"思考"，交互体验大大提升。

- [ ] **对话历史管理 (Conversation History)**
    - **目标**: 用户可以查看、返回并继续之前的每一次任务定义对话。
    - **实现**: 在侧边栏的"Task Definition"下创建一个可展开的列表，展示所有历史对话的标题和时间。点击后可以加载该对话的完整历史记录。
    - **价值**: 让用户的每一次思考和工作都有迹可循，增加了产品的粘性和专业性。

### 增强系统稳健性 (Robustness)

- [ ] **手动编辑与微调 (Manual Editing)**
    - **目标**: 在AI生成Schema后，允许用户进行手动修改。
    - **实现**: 在展示生成的JSON Schema旁边，提供一个"编辑"按钮。点击后，Schema会显示在一个文本框内，用户可以直接进行修改和保存。
    - **价值**: 解决了"AI差一点就完美"的尴尬情况，给予用户最终的控制权，体现了AI作为"助手"而非"主宰"的设计哲学。

- [ ] **周全的错误处理 (Error Handling)**
    - **目标**: 优雅地处理API调用失败、网络中断等异常情况。
    - **实现**:
        - **后端**: 确保对OpenAI API的调用有重试和超时机制。
        - **前端**: 在API请求失败时，向用户显示友好的提示信息（如："AI助理暂时无法连接，请稍后重试"），并提供一个"重试"按钮。
    - **价值**: 提升系统的可靠性，建立用户对产品的信任。

---

## 🚀 2.1 版本规划：模型感知的对话系统 (RAG)

为了让对话系统更加智能，第二阶段的**最终目标**是让AI在对话时，能够**感知到我们在Hugging Face上支持的基础模型**。这在技术上称为"检索增强生成"（Retrieval-Augmented Generation, RAG）。

### 实现思路
1.  **精选基础模型**: 首先，我们需要在Hugging Face上挑选一批适合微调的、高质量的开源模型（如 Llama-3, Mistral, BERT 等），作为我们平台支持的模型列表。
2.  **创建模型知识库**: 将这些模型的功能描述、擅长的任务、需要的数据格式等信息，处理并存入一个向量数据库中。
3.  **集成RAG流程**:
    - 当用户输入任务描述时，系统首先根据描述在模型知识库中进行**检索**，找出最匹配的几个基础模型。
    - 然后，将这些模型的信息**注入**到给GPT-4的System Prompt中。
    - GPT-4在获取了这些额外信息后，就能进行更有针对性的、**增强的**对话，从而生成更匹配、更专业的Schema。

### 带来的好处
- **更高的成功率**: 提早进行可行性分析，避免用户定义一个无法实现的任务。
- **更专业的引导**: AI的提问会基于可用模型的能力，显得更专业。
- **更流畅的体验**: 任务定义和模型选择两个阶段可以无缝衔接。

---

## 📝 建议的实现顺序

1.  **后端先行**：
    1.  先完成数据库模型 (`Conversation`, `Message`, `TaskDefinition`) 的创建和迁移。
    2.  实现不带AI逻辑的对话API，确保能正确存储和检索对话历史。
    3.  集成 OpenAI API，实现核心的问答逻辑。
    4.  最后实现 Schema 的生成和存储。
2.  **前端跟进**：
    1.  搭建基本的对话界面，并连接到后端API。
    2.  实现消息的发送、接收和展示。
    3.  处理加载和错误状态。
    4.  最后开发 Schema 的展示和确认功能。

---

## 📞 需要帮助？

- **FastAPI 文档**: 用于快速查找依赖注入、Pydantic模型等用法。
- **OpenAI API 文档**: 查看最新的函数调用（Function Calling）或JSON模式（JSON Mode）用法，这能让 Schema 生成更稳定。
- **Zustand 文档**: 用于状态管理。

---

## ✅ 第二阶段交付清单

在完成第二阶段的开发后，请确保以下所有项目都已完成并通过测试：

### 核心功能 (必须完成)
- [ ] **后端**: 对话和任务定义相关的数据库模型已创建并成功迁移。
- [ ] **后端**: 对话API (`/conversations`) 能够正确创建对话、存储和检索消息。
- [ ] **后端**: OpenAI API 已成功集成，AI能够根据对话历史和Prompt进行回应。
- [ ] **后端**: AI能够最终生成JSON Schema，并能通过API进行存储。
- [ ] **前端**: `TaskBuilder.tsx` 界面已连接到后端API，可以发送和接收消息。
- [ ] **前端**: 对话历史（用户和AI的消息）能够正确显示在界面上。
- [ ] **前端**: AI回复时的加载状态有明确的视觉提示（如loading动画）。
- [ ] **前端**: 最终生成的JSON Schema能够清晰地在界面上展示。
- [ ] **前端**: 用户可以通过点击按钮来保存生成的Schema。

### 增强功能 (目标完成)
- [ ] **流式响应**: AI的回复是以打字机的方式逐字出现在屏幕上的。
- [ ] **对话历史**: 侧边栏可以查看并进入历史对话。
- [ ] **手动编辑**: 用户可以手动编辑AI生成的Schema，并保存修改。
- [ ] **错误处理**: 当OpenAI API或网络出现问题时，前端会向用户显示友好的错误提示和重试选项。

### RAG (版本 2.1 规划)
- [ ] **模型感知**: 后端系统已具备初步的RAG能力，AI的对话和Schema生成会考虑到我们支持的基础模型（至少在Prompt层面有所体现）。

---

祝开发顺利！🚀 